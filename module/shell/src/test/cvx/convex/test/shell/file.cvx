;;
;;
;; Testing `convex.shell.file`.
;;
;;


;;;;;;;;;;


(def T
     $.test)


;;;;;;;;;; Test suites


(defn suite.delete

  ^{:doc {:description "Deleting files."}}

  []

  (T/group '((T/path.conj 'delete)

             ($.file/!.tmp)

             (def path
                  $/*result*)

             (T/trx '($.trx/precat '(($.file/!.delete path)
                                     $/*result*))
                    {:description "File deleted."})

             (T/trx '($.trx/precat '(($.file/!.delete path)
                                     (not $/*result*)))
                    {:description "Cannot delete file a second time."}))))



(defn suite.rw

  ^{:doc {:description "High-level utilities built on top of stream utilities."}}

  []

  (T/group '((T/path.conj 'rw)

             (def cell
                  '(def x
                        {:foo :bar}))

             ($.file/!.tmp)

             (def path
                  $/*result*)

             (T/trx '($.trx/precat '(($.file/!.write path
                                                     cell)
                                     ($.file/!.read path)
                                     (= cell
                                        (first $/*result*))))
                    {:description "Reading after writing."})

             ($.file/!.exec path)

             (T/trx '($.trx/precat '(($.file/!.exec path)
                                     (= {:foo :bar}
                                        x)))
                    {:description "File executed."}))))



(defn suite.stream

  ^{:doc {:description ["Low-level stream utilities."
                        "Complements tests for `convex.shell.streams`."]}}

  []

  (T/group '((T/path.conj 'stream)

             ($.file/!.tmp)

             (def path
                  $/*result*)

             ($.file/!.stream.out path)

             (def stream.out
                  $/*result*)

             ($.stream/!.outln stream.out
                               :foo)

             ($.stream/!.outln stream.out
                               :bar)

             ($.stream/!.flush stream.out)

             ($.stream/!.close stream.out)

             (T/fail.code #{:STREAM}
                          '($.stream/!.outln stream.out
                                             :baz)
                          {:description "Cannot write to closed stream."})

             ($.file/!.stream.in path)

             (def stream.in
                  $/*result*)

             (T/trx '($.trx/precat '(($.stream/!.in+ stream.in)
                                     (= '(:foo :bar)
                                        $/*result*)))
                    {:description "Ensures write was successful by reading back."})

             (T/fail.code #{:STREAM}
                          '($.stream/!.in+ stream.in)
                          {:description "Input stream autoclosed, cannot read again."})

             ($.file/!.stream.in path)

             (def stream.line
                  $/*result*)

             (T/trx '($.trx/precat '(($.stream/!.line+ stream.line)
                                     (= '(:foo)
                                        $/*result*)))
                    {:description "Read only first line."}))))


;;;


(defn suite.main

  ^{:doc {:description ["Main test suite gathering other suites."]}}

  []

  (T/group '((T/path.conj 'convex.shell.file)
             (suite.delete)
             (suite.rw)
             (suite.stream))))


;;;


(suite.main)
(T/print "convex.shell.file")
